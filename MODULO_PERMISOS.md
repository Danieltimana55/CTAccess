# M√≥dulo de Gesti√≥n de Permisos - CTAccess

## üìã Resumen

Se ha implementado un m√≥dulo completo de gesti√≥n de permisos siguiendo el sistema RBAC (Role-Based Access Control) existente en la base de datos.

---

## üóÑÔ∏è Estructura de Base de Datos

### Tablas Principales

#### 1. **permisos**
```sql
- id (PK)
- nombre (unique)
- modulo (nullable)
- descripcion (nullable)
- created_at
- updated_at
```

#### 2. **roles**
```sql
- id (PK)
- nombre (unique)
- descripcion (nullable)
- created_at
- updated_at
```

#### 3. **rol_permiso** (Pivot)
```sql
- rol_id (FK ‚Üí roles.id)
- permiso_id (FK ‚Üí permisos.id)
- PRIMARY KEY (rol_id, permiso_id)
```

#### 4. **usuario_rol** (Pivot)
```sql
- usuario_id (FK ‚Üí usuarios_sistema.idUsuario)
- rol_id (FK ‚Üí roles.id)
- PRIMARY KEY (usuario_id, rol_id)
```

---

## üìÅ Archivos Creados/Modificados

### Backend (Laravel)

#### 1. **Controlador**
üìÑ `app/Http/Controllers/System/Admin/PermissionsController.php`

**M√©todos:**
- `index()` - Lista paginada de permisos con filtros
- `store()` - Crear nuevo permiso
- `update()` - Actualizar permiso existente
- `destroy()` - Eliminar permiso

**Caracter√≠sticas:**
- ‚úÖ B√∫squeda por nombre o descripci√≥n
- ‚úÖ Filtro por m√≥dulo
- ‚úÖ Paginaci√≥n (15 por p√°gina)
- ‚úÖ Carga de relaciones (roles)
- ‚úÖ Validaciones completas
- ‚úÖ Sincronizaci√≥n autom√°tica de roles

#### 2. **Modelo**
üìÑ `app/Models/Permission.php` (ya exist√≠a)

**Relaciones:**
```php
public function roles() // belongsToMany
```

#### 3. **Seeder**
üìÑ `database/seeders/PermissionSeeder.php`

**Permisos creados:**

| M√≥dulo | Permisos |
|--------|----------|
| **Usuarios** | ver_usuarios, crear_usuarios, editar_usuarios, eliminar_usuarios |
| **Personas** | ver_personas, crear_personas, editar_personas, eliminar_personas |
| **Accesos** | ver_accesos, registrar_acceso, editar_accesos, eliminar_accesos |
| **Incidencias** | ver_incidencias, crear_incidencias, editar_incidencias, resolver_incidencias, eliminar_incidencias |
| **Reportes** | ver_historial, exportar_reportes |
| **Administraci√≥n** | ver_permisos, gestionar_permisos, gestionar_roles |

**Asignaci√≥n de permisos:**
- **Administrador**: Todos los permisos
- **Celador**: Permisos b√°sicos (ver/crear personas, registrar accesos, ver incidencias)

### Frontend (Vue.js)

#### 4. **Vista Principal**
üìÑ `resources/js/Pages/System/Admin/Permissions/Index.vue`

**Caracter√≠sticas:**
- ‚úÖ Tabla responsive con permisos
- ‚úÖ Modal compacto para crear/editar
- ‚úÖ B√∫squeda en tiempo real
- ‚úÖ Filtro por m√≥dulo
- ‚úÖ Badges para roles asignados
- ‚úÖ Iconos Lucide integrados
- ‚úÖ Modo oscuro completo
- ‚úÖ Paginaci√≥n funcional

**Columnas de la tabla:**
1. Permiso (con icono)
2. M√≥dulo (badge)
3. Descripci√≥n
4. Roles asignados (badges)
5. Acciones (Editar/Eliminar)

#### 5. **Rutas**
üìÑ `routes/web.php`

```php
Route::resource('permissions', PermissionsController::class)
    ->only(['index', 'store', 'update', 'destroy']);
```

**Rutas generadas:**
- `GET  /system/admin/permissions` ‚Üí index
- `POST /system/admin/permissions` ‚Üí store
- `PUT  /system/admin/permissions/{id}` ‚Üí update
- `DELETE /system/admin/permissions/{id}` ‚Üí destroy

#### 6. **Men√∫ de Navegaci√≥n**
üìÑ `config/menus.php`

Agregado √≠tem de men√∫:
```php
[
    'label' => 'Permisos',
    'icon'  => 'heroicon-m-lock-closed',
    'route' => 'system.admin.permissions.index',
    'can'   => 'manage-permissions',
]
```

---

## üé® Interfaz de Usuario

### Vista Principal

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Gesti√≥n de Permisos                      [+ Nuevo permiso]  ‚îÇ
‚îÇ Administra los permisos del sistema y as√≠gnalos a roles     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Buscar: [________________]  M√≥dulo: [Todos los m√≥dulos ‚ñº]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Permiso ‚îÇ M√≥dulo ‚îÇ Descripci√≥n ‚îÇ Roles ‚îÇ Acciones          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üîë ver_usuarios ‚îÇ Usuarios ‚îÇ Ver lista... ‚îÇ admin ‚îÇ Edit Del‚îÇ
‚îÇ üîë crear_usuarios‚îÇ Usuarios ‚îÇ Crear nuevos ‚îÇ admin ‚îÇ Edit Del‚îÇ
‚îÇ üîë ver_accesos  ‚îÇ Accesos  ‚îÇ Ver registros‚îÇ admin ‚îÇ Edit Del‚îÇ
‚îÇ                                    celador                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Modal de Creaci√≥n/Edici√≥n

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üîë Nuevo Permiso               [X]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üîë Nombre del permiso *             ‚îÇ
‚îÇ [ver_usuarios________________]      ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ üìÅ M√≥dulo                           ‚îÇ
‚îÇ [Usuarios____________________]      ‚îÇ
‚îÇ Agrupa permisos por funcionalidad   ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ üìÑ Descripci√≥n                      ‚îÇ
‚îÇ [Ver lista de usuarios del......]  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ üõ°Ô∏è Asignar a roles                  ‚îÇ
‚îÇ ‚òë administrador  ‚òê celador          ‚îÇ
‚îÇ Los roles seleccionados tendr√°n...  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ              [X Cancelar] [üíæ Crear]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Funcionalidades

### 1. **Listar Permisos**
- Tabla paginada con 15 permisos por p√°gina
- Muestra: nombre, m√≥dulo, descripci√≥n, roles asignados
- Orden: por m√≥dulo y luego por nombre

### 2. **Buscar Permisos**
- B√∫squeda en tiempo real
- Busca en: nombre y descripci√≥n
- Mantiene otros filtros activos

### 3. **Filtrar por M√≥dulo**
- Dropdown con m√≥dulos √∫nicos
- Opci√≥n "Todos los m√≥dulos"
- Se actualiza autom√°ticamente

### 4. **Crear Permiso**
- Modal compacto
- Campos: nombre*, m√≥dulo, descripci√≥n
- Asignaci√≥n m√∫ltiple de roles
- Validaci√≥n en tiempo real

### 5. **Editar Permiso**
- Abre modal con datos precargados
- Permite cambiar nombre (validado √∫nico)
- Actualiza m√≥dulo y descripci√≥n
- Reasigna roles

### 6. **Eliminar Permiso**
- Confirmaci√≥n antes de eliminar
- Se desasocia autom√°ticamente de roles
- Eliminaci√≥n en cascada

### 7. **Asignar a Roles**
- Checkboxes con todos los roles
- Selecci√≥n m√∫ltiple
- Sincronizaci√≥n autom√°tica en BD

---

## üîê Seguridad y Validaciones

### Backend (Laravel)

#### Validaciones de Creaci√≥n
```php
'nombre' => 'required|string|max:255|unique:permisos'
'modulo' => 'nullable|string|max:255'
'descripcion' => 'nullable|string|max:500'
'roles' => 'array'
'roles.*' => 'integer|exists:roles,id'
```

#### Validaciones de Actualizaci√≥n
```php
'nombre' => 'required|string|max:255|unique:permisos,nombre,{id}'
// (ignora el ID actual para unicidad)
```

#### Middleware
- `auth:system` - Autenticaci√≥n requerida
- `check.system.role:administrador` - Solo administradores

### Frontend (Vue)

- Validaci√≥n de campo requerido (nombre)
- Mensajes de error en tiempo real
- Botones deshabilitados durante procesamiento
- Confirmaci√≥n antes de eliminar

---

## üìä Ejemplos de Permisos

### M√≥dulo: Usuarios
```php
[
    'nombre' => 'ver_usuarios',
    'modulo' => 'Usuarios',
    'descripcion' => 'Ver lista de usuarios del sistema',
]
```

### M√≥dulo: Accesos
```php
[
    'nombre' => 'registrar_acceso',
    'modulo' => 'Accesos',
    'descripcion' => 'Registrar entrada/salida de personas',
]
```

### M√≥dulo: Incidencias
```php
[
    'nombre' => 'resolver_incidencias',
    'modulo' => 'Incidencias',
    'descripcion' => 'Marcar incidencias como resueltas',
]
```

---

## üé® Dise√±o Visual

### Badges de M√≥dulo
```html
<span class="bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">
    Usuarios
</span>
```

### Badges de Roles
```html
<span class="bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400">
    administrador
</span>
```

### Iconos Utilizados

| Elemento | Icono | Tama√±o |
|----------|-------|--------|
| Permiso | `Key` | 14px |
| M√≥dulo | `Folder` | 12px |
| Descripci√≥n | `FileText` | 12px |
| Roles | `Shield` | 12px |
| Crear | `Plus` | 16px |
| Editar | `Edit` | 12px |
| Eliminar | `Trash2` | 12px |
| Guardar | `Save` | 14px |

---

## üöÄ C√≥mo Usar

### 1. Acceder al M√≥dulo
```
Dashboard ‚Üí Permisos (en men√∫ lateral)
URL: /system/admin/permissions
```

### 2. Crear un Permiso
1. Click en "Nuevo permiso"
2. Ingresar nombre √∫nico (Ej: `ver_reportes`)
3. Opcional: Agregar m√≥dulo (Ej: `Reportes`)
4. Opcional: Agregar descripci√≥n
5. Seleccionar roles que tendr√°n este permiso
6. Click en "Crear"

### 3. Editar un Permiso
1. Click en "Editar" en la fila del permiso
2. Modificar campos necesarios
3. Agregar/quitar roles
4. Click en "Actualizar"

### 4. Buscar Permisos
- Escribir en el campo de b√∫squeda
- Los resultados se filtran autom√°ticamente
- Busca en nombre y descripci√≥n

### 5. Filtrar por M√≥dulo
- Seleccionar m√≥dulo del dropdown
- Ver solo permisos de ese m√≥dulo
- Combinar con b√∫squeda

### 6. Eliminar un Permiso
1. Click en "Eliminar"
2. Confirmar en el di√°logo
3. El permiso se elimina de todos los roles

---

## üîÑ Relaciones y Sincronizaci√≥n

### Relaci√≥n Permisos ‚Üî Roles
```php
// En Permission.php
public function roles() {
    return $this->belongsToMany(Role::class, 'rol_permiso', 'permiso_id', 'rol_id');
}

// En Role.php
public function permissions() {
    return $this->belongsToMany(Permission::class, 'rol_permiso', 'rol_id', 'permiso_id');
}
```

### Sincronizaci√≥n Autom√°tica
```php
// Al crear/editar permiso
$permiso->roles()->sync($validated['roles']);

// Sincroniza tabla pivot autom√°ticamente:
// - Agrega nuevas relaciones
// - Elimina relaciones no seleccionadas
// - Mantiene existentes
```

---

## üìà Estad√≠sticas

### Permisos Creados por el Seeder
- **Total**: 22 permisos
- **M√≥dulos**: 5 (Usuarios, Personas, Accesos, Incidencias, Reportes, Administraci√≥n)
- **Asignados a Admin**: 22 (todos)
- **Asignados a Celador**: 7 (b√°sicos)

### M√≥dulos Disponibles
1. **Usuarios** - 4 permisos
2. **Personas** - 4 permisos
3. **Accesos** - 4 permisos
4. **Incidencias** - 5 permisos
5. **Reportes** - 2 permisos
6. **Administraci√≥n** - 3 permisos

---

## ‚úÖ Checklist de Implementaci√≥n

- [x] Modelo Permission existente verificado
- [x] Controlador PermissionsController creado
- [x] Rutas RESTful configuradas
- [x] Vista Index.vue con modal creada
- [x] Integraci√≥n de iconos Lucide
- [x] Modo oscuro completo implementado
- [x] Filtros de b√∫squeda y m√≥dulo
- [x] Paginaci√≥n funcional
- [x] Validaciones backend y frontend
- [x] Seeder con permisos de ejemplo
- [x] Asignaci√≥n autom√°tica a roles
- [x] Men√∫ de navegaci√≥n actualizado
- [x] Compilaci√≥n exitosa
- [x] Seeder ejecutado correctamente

---

## üîÆ Mejoras Futuras Sugeridas

1. **M√≥dulo de Roles**: Crear vista para gestionar roles
2. **Asignaci√≥n masiva**: Asignar m√∫ltiples permisos a un rol
3. **Permisos compuestos**: Permisos que requieren otros permisos
4. **Historial de cambios**: Log de qui√©n modifica permisos
5. **Importar/Exportar**: JSON de permisos para backup
6. **Permisos por usuario**: Override de permisos individuales
7. **Dashboard de permisos**: Matriz visual de roles/permisos
8. **Validaci√≥n en uso**: Prevenir eliminar permisos en uso

---

## üìû Endpoints API

```
GET    /system/admin/permissions            Lista de permisos
POST   /system/admin/permissions            Crear permiso
PUT    /system/admin/permissions/{id}       Actualizar permiso
DELETE /system/admin/permissions/{id}       Eliminar permiso
```

**Query Parameters:**
- `q` - B√∫squeda por texto
- `modulo` - Filtro por m√≥dulo
- `page` - N√∫mero de p√°gina

---

## üéì Notas T√©cnicas

### Convenci√≥n de Nombres
```
Formato: {accion}_{recurso}
Ejemplos:
- ver_usuarios
- crear_accesos
- editar_incidencias
- resolver_incidencias
- exportar_reportes
```

### M√≥dulos Recomendados
- Usa nombres en singular o plural seg√∫n el contexto
- Primera letra en may√∫scula
- Agrupa funcionalidades relacionadas
- Ejemplos: Usuarios, Accesos, Incidencias, Reportes

### Sincronizaci√≥n vs Attach
```php
// sync() - Reemplaza todas las relaciones
$permiso->roles()->sync([1, 2, 3]);

// attach() - Agrega sin eliminar existentes
$permiso->roles()->attach([4, 5]);

// syncWithoutDetaching() - Agrega garantizando inclusi√≥n
$permiso->roles()->syncWithoutDetaching([1, 6]);
```

---

**Fecha de creaci√≥n**: 14 de Octubre, 2025  
**Versi√≥n**: 1.0  
**Estado**: ‚úÖ Completado y funcional  
**Desarrollador**: Sistema CTAccess
